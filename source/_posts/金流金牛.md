---
title: 金流金牛
date: 2021-11-25 16:10:28
index_img: https://images.chinatimes.com/newsphoto/2019-10-10/1024/20191010002220.jpg
categories: 
- [疑難雜症]
tags: [ 金流, api, PHP , 疑難雜症]
---

# <font color=#FF6600>金流api、開立發票</font>

最近開始碰到這個功能，包括台新apple pay、Line pay等等，

簡單來說這個功能就是，他給你文件，文件上會跟你說他要什麼，然後他會回給你什麼

你要做的事情，就是把他要的弄出來，把他回傳的東西接回來處理

<!-- more -->

如果沒有上面那一塊定義，我可能到現在還搞不懂金流跟綠界發票怎麼用

文件很臭很長，我對讀文件這件事情真的是毫無辦法，不然套用老人家說的，我早就讀到第一學府了(?)

簡單來說，碰到付款就會碰到金流的問題，金流有各個廠商店家不同，複雜度也會不同

舉例我接觸的這兩個，line pay要先[申請SandBox帳號](https://pay.line.me/tw/developers/techsupport/sandbox/save?locale=zh_TW)測試，申請完畢後會送你一組帳號密碼。

登入之後就可以取得屬於你自己的key跟ID，然後要加入伺服器IP來接收(白名單)，這塊我還沒弄懂。

Header的部分就有`Content-Type`(基本每個都有這項)；`X-LINE-ChannelId`(你的ID)；`X-LINE-Authorization-Nonce`(目前還不知道放什麼)；`X-LINE-Authorization`(跟剛剛那個很像但似乎不一樣)

[測試流程](https://pay.line.me/tw/developers/techsupport/sandbox/testflow?locale=zh_TW)要進行base64加密等等，因為沒有親自跑過只有看過，他的複雜度比我自己實際使用的台新apple pay麻煩多了

台新部分就是他會跟你要某些資料，例如訂單資訊、金額等等。然後把這些資料包成json丟給他，他會回傳成功或失敗等等的狀態給你，相關的資訊都可以在文件上找的到，沒有加密解密問題。

##### <font color=#DD2222>台新apple pay注意的點： 送出的資料與格式</font>
##### <font color=#DD2222>Line pay注意的點： 加密的方式及類型</font>
---

然後金流處理完之後
---

發票就是接下來的工作了，綠界文件大家都說很詳細照著做就好，但...我就不會讀文件阿！

就像主管會說，google就找的到資料了，我發現我下的關鍵字都不正確，沒辦法找到自己要的東西

就算東西出來了，也沒辦法解決我的問題，我嘗試把範例原封不動的搬上去，都還是會碰到一些問題

像目前就卡在Data找不到，利用json-URL-AES加密後，對他來說資料還是空空如也。

明天就是週五，希望能有機會突然驚醒或是有天神下凡指導，總覺得有人溝通真的更能確信自己在做的東西方向是對還是錯誤。

最晚也希望下週能把這些東西產出來...加油

+ 2021.11.26
---
讀了一整遍還是出不來，但做了一些測試，以官方提供的測試範例施作時，會出現

`"TransMsg": "The parameter [Data] decrypt fail",`

的錯誤，~~可能是我data直接包或是轉譯沒轉好，但目前仍找不到問題出在哪~~

官方範例

除了時間跟檔案編號有改之外，其他都是原封不動

~~也嘗試過URL跟AES加密再送出，一樣是回傳data無法解析的問題~~

```
{
    "MerchantID": 2000132,
    "RqHeader": {
        "Timestamp": 1637905000,
        "Revision": "3.0.0"
    },
    "Data": {
        "MerchantID": "2000132",
        "RelateNumber": "20211125648330501",
        "CustomerID": "",
        "CustomerIdentifier": "",
        "CustomerName": "綠界科技股份有限公司",
        "CustomerAddr": "106 台北市南港區發票一街 1 號 1 樓",
        "CustomerPhone": "",
        "CustomerEmail": "test@ecpay.com.tw",
        "ClearanceMark": "1",
        "Print": "1",
        "Donation": "0",
        "LoveCode": "",
        "CarrierType": "",
        "CarrierNum": "",
        "TaxType": "1",
        "SalesAmount": 100,
        "InvoiceRemark": "發票備註",
        "InvType": "07",
        "vat": "1",
        "Items": [
            {
                "ItemSeq": 1,
                "ItemName": "item01",
                "ItemCount": 1,
                "ItemWord": "件",
                "ItemPrice": 50,
                "ItemTaxType": "1",
                "ItemAmount": 50,
                "ItemRemark": "item01_desc"
            },
            {
                "ItemSeq": 2,
                "ItemName": "item02",
                "ItemCount": 1,
                "ItemWord": "個",
                "ItemPrice": 20,
                "ItemTaxType": "1",
                "ItemAmount": 20,
                "ItemRemark": "item02_desc"
            },
            {
                "ItemSeq": 3,
                "ItemName": "item03",
                "ItemCount": 3,
                "ItemWord": "粒",
                "ItemPrice": 10,
                "ItemTaxType": "1",
                "ItemAmount": 30,
                "ItemRemark": "item03_desc"
            }
        ]
    }
}
```

~~然後自己的測試環境也是data出問題，看來怎麼處理data這塊東西可能是我突破發票這道關卡的因素了~~

+ 2021.11.29 我大學長點醒了我的問題，讓我發現一件事情

<font color=#00FF00>關於AES加密</font>，不像URL那樣直接丟出去就會幫你轉好

AES是有key 跟 iv 的，錯誤即會造成解析錯誤

所以其中一個學長說:<font color=#FF00FF>\[你把範例解開來就知道啦！\]</font>，我這時才發現我的**愚蠢**，原來我加密出來的東西根本是兩個不同的東西

另外一個學長則是很好心的幫我釐清整個流程，更讓我確信，我是在加密這一塊出問題

自然而然他就會回復加密<font color=#FF0000>錯誤的訊息</font>了

![](/img/AmountApiError.png)

終於在處理完這塊後

![](/img/AmountApiSuccess.png)

謝天謝地謝謝好學長們，看來今天又比昨天的我成長了一些(˘•ω•˘)
---

處理完單存開立發票的功能之後，繼續處理折讓部分就會簡單多了(也是此次研發的功能之一)

發票折讓就是類似於退貨的關係.....嗎?(舉例來說)

折讓的code也跟說明書說的一樣

```
 {
 "MerchantID": "2000132",
 "RqHeader": {
 "Timestamp": 1638164115,
 "Revision": "3.0.0"
 },
 "Data": "{
"MerchantID": "2000132",
"InvoiceNo": "ZM80000032",
"InvoiceDate": "2021/11/29",
"AllowanceNotify": "E",
"CustomerName": "綠界科技股份有限公司",
"NotifyMail": "test@ecpay.com.tw",
"NotifyPhone": "0912345678",
"AllowanceAmount": 60,
"Items": [
{
"ItemSeq": 1,
"ItemName": "item01",
"ItemCount": 1,
"ItemWord": "件",
"ItemPrice": 50,
"ItemTaxType": "2",
"ItemAmount": 50
},
{
"ItemSeq": 3,
"ItemName": "item03",
"ItemCount": 1,
"ItemWord": "粒",
"ItemPrice": 10,
"ItemTaxType": "1",
"ItemAmount": 10
}
]
}"
}

```

其中開立成功後會有發票號碼，折讓則是要對著發票號碼去做設定。

一開始再開立發票時所提供的自訂編號只是一種類似於命名的關係，方便去尋找你這筆資料

想當然所有Data的東西還是要透過AES方式去加密。一樣在多注意key與iv的關係。

不過目前位於最後可折讓金額的關係還是有點不清楚，應該是上述友重新送出的品項代表最後發票留下來的東西。

所以會是相反的40元而不是60。

##### <font color=#FFD700>綠界要注意的點：時間點、AES加密、品項對應內容、格式</font>



